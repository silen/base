<?php
namespace Mt\Controller;
class P1Controller extends AuthController {

    private $sModel;
    public function __construct() {
        parent::__construct();
        $this->sModel = M('p1_member_log');
        $this->assign('seo', array('title'=>'新年活动管理'));
    }
    public function index()
    {
        $page = I('get.p');
        $page = $page ? $page : 1;
        $size = 15;
        $where = array();
        $list = $this->getData($where, $page, $size);
        $count      = $this->sModel->where($where)->count();// 查询满足要求的总记录数
        $Page       = new \Think\Page($count, $size);// 实例化分页类 传入总记录数和每页显示的记录数(25)
        $Page->setConfig('prev','上一页');
        $Page->setConfig('next','下一页');
        $show       = $Page->show();// 分页显示输出
        $this->assign('list', $list);
        $this->assign('show', $show);

        $this->display();
    }

    private function getData($where, $page, $size)
    {
        $list = $this->sModel->where($where)->page("{$page}, {$size}")->order('id DESC')->select();
        foreach ($list as &$v){
            $v['data'] = unserialize($v['data']);
        }

        return $list;
    }

    public function count()
    {
        $list = $this->sModel->field("date_format(FROM_UNIXTIME( `addtime`),'%Y%m%d') AS time,count(*) AS c")->group("date_format(FROM_UNIXTIME( `addtime`),'%Y%m%d')")->select();
        //{:date('Y年m月d日', strtotime($key))}
        $this->assign('list', $list);

        $this->display();
    }

}